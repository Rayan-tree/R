<!DOCTYPE html>
<html lang="zh-CN">
<head>
   <meta charset="UTF-8">
    <!-- å…³é”®ï¼šç¦æ­¢ç”¨æˆ·ç¼©æ”¾ï¼Œé€‚é…æ‰‹æœºå±å¹• -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI Text RPG</title>
    
    <!-- PWA Manifest é“¾æ¥ -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS ä¸“ç”¨è®¾ç½® (è®©å®ƒåœ¨ iPhone ä¸Šåƒ App ä¸€æ ·å…¨å±) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI RPG">
    
    <!-- å›¾æ ‡è®¾ç½® (è¯·ç¡®ä¿ä½ æœ‰ icon.png è¿™ä¸ªå›¾ç‰‡) -->
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    <style>
        :root {
            --bg-color: #000000;
            --text-user: #888888;
            --text-ai: #ffffff;
            --text-link: #4A90E2;
            --ui-bg: #1C1C1E;
            --ui-border: #333;
            --accent: #0A84FF;
            --danger: #FF453A;
            --success: #30D158;
            --select-active: #30D158;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-ai);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
             padding-bottom: env(safe-area-inset-bottom); 
        }

        /* --- Header --- */
        .header {
            position: fixed; top: 0; left: 0; width: 100%; height: 50px;
            display: flex; align-items: center; padding: 0 15px; z-index: 100;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), rgba(0,0,0,0));
        }
        .icon-btn {
            background: none; border: none; cursor: pointer; padding: 8px;
            color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:active { background-color: rgba(255,255,255,0.1); }
        
        /* --- Sidebar --- */
        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .sidebar {
            position: fixed; top: 0; left: 0; width: 85%; max-width: 320px; height: 100%;
            background-color: var(--ui-bg); z-index: 201;
            transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            padding: 20px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.5);
        }
        .sidebar.open { transform: translateX(0); }
        .sidebar-overlay.open { opacity: 1; pointer-events: auto; }
        
        .sidebar-title { font-size: 22px; font-weight: bold; margin: 10px 0 20px 0; padding-left: 10px; }
        .menu-category { font-size: 12px; color: #666; margin: 15px 0 5px 10px; text-transform: uppercase; letter-spacing: 1px; }
        .menu-item {
            display: flex; align-items: center; gap: 15px; padding: 12px 15px;
            background: #2C2C2E; border-radius: 10px; cursor: pointer; transition: background 0.2s;
        }
        .menu-item:active { background: #3A3A3C; }
        .menu-item svg { width: 20px; height: 20px; color: var(--accent); }
        .menu-item.danger { color: var(--danger); border: 1px solid rgba(255, 69, 58, 0.3); }
        .menu-item.danger svg { color: var(--danger); }

        /* --- Chat Area --- */
        #game-container {
            flex: 1; overflow-y: auto; padding: 60px 20px 80px 20px;
            display: flex; flex-direction: column; gap: 15px;
        }
        .message { line-height: 1.6; font-size: 16px; white-space: pre-wrap; user-select: text; }
        .msg-user { color: var(--text-user); }
        .msg-ai { color: var(--text-ai); }
        .choice-link { color: var(--text-link); text-decoration: none; cursor: pointer; display: block; margin: 4px 0; }
        
        /* Diff Colors */
        .diff-pos { color: var(--success); font-weight: bold; }
        .diff-neg { color: var(--danger); font-weight: bold; }
        
        /* Summary Details */
        details {
            background: #111; padding: 10px; border-radius: 8px; margin: 10px 0; border: 1px solid #333;
        }
        summary { color: #888; cursor: pointer; font-size: 14px; font-weight: bold; list-style: none; }
        summary::-webkit-details-marker { display: none; }
        summary::before { content: "â–¶ "; display: inline-block; margin-right: 5px; transition: transform 0.2s; }
        details[open] summary::before { transform: rotate(90deg); }
        .summary-content { font-size: 14px; color: #aaa; margin-top: 10px; font-style: italic; }

        .loading { color: var(--text-ai); font-style: italic; opacity: 0.7; }
        /* Cursor for streaming */
        .typing-cursor::after { content: "â–‹"; animation: blink 1s infinite; color: var(--accent); }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* --- Input --- */
        .input-area {
            position: fixed; bottom: 0; left: 0; width: 100%;
            padding: 10px 15px; background-color: var(--bg-color);
            display: flex; gap: 10px; border-top: 1px solid #333; z-index: 50;
        }
        #user-input { flex: 1; background: #1C1C1E; border: none; border-radius: 20px; padding: 10px 15px; color: white; font-size: 16px; outline: none; }
        #send-btn { background: var(--accent); color: white; border: none; border-radius: 20px; padding: 0 20px; font-weight: bold; cursor: pointer; }

        /* --- Page Modals --- */
        .page-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 300;
            transform: translateX(100%); transition: transform 0.3s;
            display: flex; flex-direction: column;
        }
        .page-modal.active { transform: translateX(0); }
        .page-header {
            padding: 15px; display: flex; align-items: center; gap: 10px;
            border-bottom: 1px solid #333; background: var(--ui-bg);
        }
        .page-content { padding: 20px; overflow-y: auto; flex: 1; }
        
        /* Forms */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; color: #888; margin-bottom: 8px; font-size: 14px; }
        .form-input, .form-textarea, .form-select {
            width: 100%; background: #1C1C1E; border: 1px solid #333;
            color: white; padding: 12px; border-radius: 8px; font-size: 16px; outline: none;
        }
        .form-textarea { height: 120px; resize: none; }
        .btn-primary { width: 100%; background: var(--accent); color: white; border: none; padding: 14px; border-radius: 12px; font-size: 16px; font-weight: bold; margin-top: 10px; }
        .btn-secondary { background: #333; color: white; border: none; padding: 10px; border-radius: 8px; font-size: 14px; margin-top: 5px; width: 100%; }
        .btn-ai { background: linear-gradient(135deg, #0A84FF, #5E5CE6); color: white; border: none; padding: 10px; border-radius: 8px; font-size: 14px; margin-bottom: 10px; width: 100%; display:flex; justify-content: center; align-items: center; gap: 5px;}
        .btn-danger { background: var(--danger); }

        /* Toggles & Sliders */
        .toggle-row { display: flex; justify-content: space-between; align-items: center; background: #1C1C1E; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 30px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .range-slider { width: 100%; -webkit-appearance: none; background: #333; height: 5px; border-radius: 5px; outline: none; }
        .range-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: var(--accent); border-radius: 50%; cursor: pointer; }

        /* List Items */
        .list-item {
            background: #1C1C1E; padding: 15px; border-radius: 12px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 15px; cursor: pointer; border: 1px solid transparent;
        }
        .list-item.active-item { border-color: rgba(48, 209, 88, 0.3); background: #232325; }
        .select-indicator { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #555; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .active-item .select-indicator { border-color: var(--select-active); background: var(--select-active); }
        .active-item .select-indicator::after { content: "âœ“"; color: #000; font-weight: bold; font-size: 14px; }
        .list-info { flex: 1; overflow: hidden; }
        .list-title { font-weight: bold; font-size: 16px; margin-bottom: 4px; }
        .list-desc { color: #888; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .edit-btn { padding: 8px; color: var(--accent); z-index: 2; }
        .delete-btn { padding: 8px; color: var(--danger); z-index: 2; }

        /* Action Sheet & Modals */
        .action-sheet-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 500; opacity: 0; pointer-events: none;
            transition: opacity 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .action-sheet-overlay.open { opacity: 1; pointer-events: auto; }
        .action-menu { background: #1C1C1E; width: 80%; border-radius: 14px; overflow: hidden; transform: scale(0.9); transition: transform 0.2s; }
        .action-sheet-overlay.open .action-menu { transform: scale(1); }
        .action-item { padding: 15px; text-align: center; border-bottom: 1px solid #333; font-size: 18px; color: var(--accent); cursor: pointer; }
        .action-item.destructive { color: var(--danger); }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <button class="icon-btn" onclick="toggleSidebar()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
    </div>

    <!-- Main Game Area -->
    <div id="game-container"></div>

    <!-- Input Area -->
    <div class="input-area">
        <input type="text" id="user-input" placeholder="è¾“å…¥è¡ŒåŠ¨...">
        <button id="send-btn" onclick="handleSend()">å‘é€</button>
    </div>

    <!-- Sidebar -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar">
        <div class="sidebar-title">RPG V5 æ§åˆ¶å°</div>
        
        <div class="menu-category">æ ¸å¿ƒåŠŸèƒ½</div>
        <div class="menu-item" onclick="openPage('page-saves')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
            <span>å­˜æ¡£ / è¯»æ¡£ </span>
        </div>
        <div class="menu-item" onclick="openPage('page-memory-hub')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
            <span>è®°å¿†ç³»ç»Ÿ </span>
        </div>

        <div class="menu-category">æ•°æ®</div>
        <div class="menu-item" onclick="openPage('page-content-hub')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
            <span>ä¸–ç•Œæ•°æ®ç®¡ç†</span>
        </div>
        
        <div class="menu-category">ç³»ç»Ÿ</div>
        <div class="menu-item" onclick="openPage('page-api')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
            <span>API è®¾ç½®</span>
        </div>
        <div class="menu-item" onclick="openPage('page-features')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            <span>åŠŸèƒ½è®¾ç½®</span>
        </div>
        
        <div class="menu-category" style="margin-top: 30px;">å±é™©åŒºåŸŸ</div>
        <div class="menu-item danger" onclick="resetStory()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            <span>æ¸…ç©ºå½“å‰å‰§æƒ…</span>
        </div>
    </div>

    <!-- ================= PAGES ================= -->

    <!-- Page: Memory System -->
    <div id="page-memory-hub" class="page-modal">
        <div class="page-header">
            <button class="icon-btn" onclick="closePage('page-memory-hub')"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></button>
            <h3>è®°å¿†</h3>
        </div>
        <div class="page-content">
            <div class="form-group">
                <label class="form-label">è®°å¿†ä¸Šé™ (Context Window)</label>
                <input type="number" id="mem-limit" class="form-input" value="30" placeholder="å›åˆæ•° (1æ¥å›=1å›åˆ)">
            </div>
            
            <div class="toggle-row">
                <span>è‡ªåŠ¨è®°å¿†æ€»ç»“å¼€å…³</span>
                <label class="switch"><input type="checkbox" id="feature-auto-mem"><span class="slider"></span></label>
            </div>
            <div class="form-group">
                <label class="form-label">è‡ªåŠ¨æ€»ç»“é—´éš” (å›åˆ)</label>
                <input type="number" id="mem-interval" class="form-input" value="20">
            </div>

            <div class="menu-item" style="margin-bottom:15px; background:#2C2C2E;" onclick="openList('mem_prompts')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                <span>æ€»ç»“æç¤ºè¯ç­–ç•¥ (Selection)</span>
            </div>

            <hr style="border:1px solid #333; margin:20px 0;">
            <div class="form-group">
                <label class="form-label">é•¿æ—¶è®°å¿† (Long-Term Memory)</label>
                <textarea id="mem-current" class="form-textarea" style="height:150px" placeholder="è¿™é‡Œå­˜å‚¨ AI å¯¹è¿‡å»å‰§æƒ…çš„é•¿æœŸè®°å¿†..."></textarea>
                <small style="color:#666; display:block; margin-top:5px;">è‡ªåŠ¨æ€»ç»“çš„å†…å®¹ä¼šè¿½åŠ åˆ°è¿™é‡Œï¼Œä¸ä¼šè¦†ç›–ã€‚</small>
            </div>
            <button class="btn-ai" onclick="triggerSummary()">âš¡ ç«‹å³è¿›è¡Œè®°å¿†æ€»ç»“ (è¿½åŠ )</button>
            <button class="btn-primary" onclick="saveMemorySettings()">ä¿å­˜è®°å¿†è®¾ç½®</button>
        </div>
    </div>

    <!-- Page: Content Hub -->
    <div id="page-content-hub" class="page-modal">
        <div class="page-header">
            <button class="icon-btn" onclick="closePage('page-content-hub')"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></button>
            <h3>ä¸–ç•Œæ•°æ®ç®¡ç†</h3>
        </div>
        <div class="page-content">
            <div class="menu-item" onclick="openList('worldbooks')"><span>ğŸ“– ä¸–ç•Œä¹¦ (World Setting)</span></div>
            <div class="menu-item" style="margin-top:10px" onclick="openList('statusbars')"><span>ğŸ“Š çŠ¶æ€æ æ¨¡æ¿ (Status Bars)</span></div>
            <div class="menu-item" style="margin-top:10px" onclick="openList('personas')"><span>ğŸ­ User äººè®¾</span></div>
            <div class="menu-item" style="margin-top:10px" onclick="openList('styles')"><span>ğŸ–‹ï¸ æ–‡é£è®¾ç½®</span></div>
            <div class="menu-item" style="margin-top:10px" onclick="openList('breaks')"><span>ğŸ”“ ç ´é™ / é«˜çº§æŒ‡ä»¤</span></div>
            <div class="menu-item" style="margin-top:10px" onclick="openList('summary_prompts')"><span>ğŸ“ æ‘˜è¦æç¤ºè¯ (Per Msg)</span></div>
            
            <div style="height:1px; background:#333; margin:20px 0;"></div>
            <div class="menu-item" onclick="openList('maps')"><span>ğŸ—ºï¸ åœ°å›¾ (Maps)</span></div>
            <div class="menu-item" style="margin-top:10px" onclick="openList('characters')"><span>ğŸ‘¤ äººç‰© (Characters)</span></div>
            <div class="menu-item" style="margin-top:10px" onclick="openList('inventory')"><span>ğŸ’ ç‰©å“ (Inventory)</span></div>
        </div>
    </div>

    <!-- Page: Saves -->
    <div id="page-saves" class="page-modal">
        <div class="page-header">
            <button class="icon-btn" onclick="closePage('page-saves')"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></button>
            <h3>å­˜æ¡£ç®¡ç†</h3>
            <button class="icon-btn" style="margin-left:auto; color:var(--accent)" onclick="createSave()">+</button>
        </div>
        <div class="page-content" id="saves-container"></div>
    </div>

    <!-- Page: Author Note -->
    <div id="page-author-note" class="page-modal">
        <div class="page-header">
            <button class="icon-btn" onclick="closePage('page-author-note')"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></button>
            <h3>ä½œè€…é™„è¨€</h3>
        </div>
        <div class="page-content">
            <p style="font-size:12px; color:#888; margin-bottom:10px;">æœ€é«˜æƒé‡æŒ‡ä»¤ï¼Œæ’å…¥ Prompt æœ«å°¾ã€‚</p>
            <textarea id="author-note-input" class="form-textarea" style="height:200px" placeholder="è¾“å…¥ä½œè€…é™„è¨€..."></textarea>
            <button class="btn-primary" onclick="saveAuthorNote()">ä¿å­˜é™„è¨€</button>
        </div>
    </div>

    <!-- Generic List Page -->
    <div id="page-list" class="page-modal">
        <div class="page-header">
            <button class="icon-btn" onclick="closePage('page-list')"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></button>
            <h3 id="list-title">åˆ—è¡¨</h3>
            <button class="icon-btn" style="margin-left:auto; color:var(--accent)" onclick="openEditor(-1)">+</button>
        </div>
        <div class="page-content">
            <div style="font-size:12px; color:#666; margin-bottom:10px;">ç‚¹å‡»åœ†åœˆåˆ‡æ¢çŠ¶æ€ (å®å¿ƒ=ç”Ÿæ•ˆ)</div>
            <div id="list-container"></div>
        </div>
    </div>

    <!-- Generic Editor Page -->
    <div id="page-editor" class="page-modal" style="z-index:310;">
        <div class="page-header">
            <button class="icon-btn" onclick="closePage('page-editor')">å–æ¶ˆ</button>
            <h3 id="editor-title">ç¼–è¾‘</h3>
        </div>
        <div class="page-content">
            <button id="btn-ai-gen" class="btn-ai" style="display:none" onclick="generateAIContent()">âœ¨ AI è‡ªåŠ¨ç”Ÿæˆ</button>
            <div id="editor-fields"></div>
            <button class="btn-primary" onclick="saveEntry()">ä¿å­˜</button>
            <button class="btn-secondary btn-danger" onclick="deleteEntry()" id="btn-delete">åˆ é™¤</button>
        </div>
    </div>

    <!-- Page: API Settings -->
    <div id="page-api" class="page-modal">
        <div class="page-header">
            <button class="icon-btn" onclick="closePage('page-api')"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></button>
            <h3>API è®¾ç½®</h3>
        </div>
        <div class="page-content">
            <div class="form-group"><label class="form-label">API Base URL</label><input type="text" id="api-url" class="form-input" placeholder="https://api.openai.com/v1"></div>
            <div class="form-group"><label class="form-label">API Key</label><input type="password" id="api-key" class="form-input" placeholder="sk-..."></div>
            <div class="form-group">
                <label class="form-label">Temperature (æ¸©åº¦): <span id="temp-val">1.0</span></label>
                <input type="range" id="api-temp" class="range-slider" min="0" max="2" step="0.1" value="1.0" oninput="document.getElementById('temp-val').innerText=this.value">
                <small style="color:#666;">ä½=ä¿å®ˆç¨³å®š; é«˜=åˆ›æ„éšæœº</small>
            </div>
            <button class="btn-secondary" onclick="fetchModels()">æ‹‰å–æ¨¡å‹åˆ—è¡¨</button>
            <div class="form-group" style="margin-top:10px;"><label class="form-label">é€‰æ‹©æ¨¡å‹</label><select id="api-model" class="form-select"></select></div>
            <button class="btn-primary" onclick="saveApiSettings()">ä¿å­˜é…ç½®</button>
        </div>
    </div>

    <!-- Page: Features -->
    <div id="page-features" class="page-modal">
        <div class="page-header">
            <button class="icon-btn" onclick="closePage('page-features')"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></button>
            <h3>åŠŸèƒ½è®¾ç½®</h3>
        </div>
        <div class="page-content">
            <div class="toggle-row"><span>å‰§æƒ…é€‰æ‹©å¼€å…³</span><label class="switch"><input type="checkbox" id="feature-choices"><span class="slider"></span></label></div>
            <div class="toggle-row"><span>çŠ¶æ€æ å¼€å…³</span><label class="switch"><input type="checkbox" id="feature-statusbar"><span class="slider"></span></label></div>
            <div class="toggle-row"><span>æ•°å€¼å˜åŒ–æç¤ºå¼€å…³</span><label class="switch"><input type="checkbox" id="feature-diffs"><span class="slider"></span></label></div>
            <div class="toggle-row"><span>æŠ˜å æ‘˜è¦å¼€å…³ (Summary)</span><label class="switch"><input type="checkbox" id="feature-summary"><span class="slider"></span></label></div>
            <p style="font-size:12px; color:#666;">å¼€å¯åï¼Œæ¯æ¬¡å›å¤å°†åŒ…å«ä¸€æ®µæŠ˜å çš„å‰§æƒ…æ‘˜è¦ï¼Œå¸®åŠ© AI è®°å¿†ã€‚</p>
            <button class="btn-primary" onclick="saveFeatureSettings()">ä¿å­˜è®¾ç½®</button>
        </div>
    </div>

    <!-- Edit Msg Modal -->
    <div id="edit-modal" class="page-modal" style="z-index: 600;">
        <div class="page-header"><button class="icon-btn" onclick="closeEditModal()">å–æ¶ˆ</button><h3>ç¼–è¾‘å†…å®¹</h3></div>
        <div class="page-content">
            <textarea id="edit-msg-textarea" class="form-textarea" style="height: 300px;"></textarea>
            <button class="btn-primary" onclick="confirmMsgEdit()">ç¡®è®¤ä¿®æ”¹</button>
        </div>
    </div>

    <!-- Action Sheet -->
    <div id="action-sheet" class="action-sheet-overlay" onclick="closeActionSheet()">
        <div class="action-menu" onclick="event.stopPropagation()">
            <div class="action-item" onclick="actionEdit()">ç¼–è¾‘</div>
            <div class="action-item" onclick="actionRegenerate()">é‡æ¥ (Regenerate)</div>
            <div class="action-item destructive" onclick="actionDelete()">åˆ é™¤</div>
        </div>
    </div>

    <script>
        // --- DATA STRUCTURE V5 ---
        const state = {
            messages: [],
            settings: {
                apiUrl: "https://api.openai.com/v1", apiKey: "", model: "gpt-3.5-turbo", temperature: 1.0,
                enableChoices: true, enableStatus: true, enableDiffs: true, enableSummary: true, enableAutoMem: false,
                authorNote: ""
            },
            memory: { limit: 30, interval: 20, current: "", turnCount: 0 },
            content: {
                worldbooks: [],
                personas: [],   
                styles: [],     
                breaks: [],     
                statusbars: [],
                summary_prompts: [], // New: For the per-message collapsible summary
                mem_prompts: [],     // New: For the long-term memory auto-summary
                maps: [],       
                characters: [], 
                inventory: []   
            },
            saves: [],
            ui: { currentCategory: '', editingId: -1, selectedMsgIndex: -1, longPressTimer: null }
        };

        // --- Config ---
        const CAT_CONFIG = {
            worldbooks: { title: "ä¸–ç•Œä¹¦", type: "single", fields: ['name', 'content'], prompt: "world setting" },
            statusbars: { title: "çŠ¶æ€æ æ¨¡æ¿", type: "single", fields: ['name', 'content'], prompt: null },
            personas:   { title: "Useräººè®¾", type: "single", fields: ['name', 'content'], prompt: null },
            styles:     { title: "æ–‡é£", type: "single", fields: ['name', 'content'], prompt: null },
            breaks:     { title: "ç ´é™/æŒ‡ä»¤", type: "single", fields: ['name', 'content'], prompt: null },
            summary_prompts: { title: "æ‘˜è¦æç¤ºè¯(æ¯æ¡)", type: "single", fields: ['name', 'content'], prompt: null },
            mem_prompts:     { title: "è®°å¿†æ€»ç»“ç­–ç•¥", type: "single", fields: ['name', 'content'], prompt: null },
            maps:       { title: "åœ°å›¾", type: "single", fields: ['name', 'content'], prompt: "map description" },
            characters: { title: "äººç‰©", type: "multi",  fields: ['name', 'bio', 'personality', 'opinion', 'memory'], prompt: "character" },
            inventory:  { title: "ç‰©å“", type: "multi",  fields: ['name', 'desc'], prompt: "item" }
        };
        const FIELD_LABELS = { name: "åç§°", content: "å†…å®¹/æç¤ºè¯", desc: "ä»‹ç»", bio: "åŸºæœ¬ä»‹ç»", personality: "æ€§æ ¼", opinion: "å¯¹Userçœ‹æ³•", memory: "é‡è¦è®°å¿†" };

        // --- Init ---
        window.onload = () => {
            loadData();
            // Defaults
            if(state.content.styles.length===0) state.content.styles.push({name:"é»˜è®¤",content:"",active:true});
            if(state.content.statusbars.length===0) state.content.statusbars.push({name:"é»˜è®¤RPG",content:"çŠ¶æ€æ ï¼š\n[HP]: 100/100\n[é‡‘å¸]: 0",active:true});
            if(state.content.summary_prompts.length===0) state.content.summary_prompts.push({name:"é»˜è®¤æ‘˜è¦",content:"è¯·ç”¨50å­—ä»¥å†…æ€»ç»“æœ¬æ®µå‰§æƒ…ã€‚",active:true});
            if(state.content.mem_prompts.length===0) state.content.mem_prompts.push({name:"é»˜è®¤ç­–ç•¥",content:"è¯·æ€»ç»“ä¹‹å‰å‰§æƒ…çš„å…³é”®è¿›å±•ï¼Œå»é™¤çç¢å¯¹è¯ï¼Œä¿ç•™é‡è¦çº¿ç´¢å’ŒçŠ¶æ€å˜åŒ–ã€‚",active:true});

            if(state.messages.length === 0) appendMessage('assistant', 'V5 ç³»ç»Ÿå°±ç»ªã€‚æµå¼ä¼ è¾“å·²å¯ç”¨ã€‚');
            else reRenderChat();
            
            // UI Pop
            document.getElementById('api-url').value = state.settings.apiUrl;
            document.getElementById('api-key').value = state.settings.apiKey;
            document.getElementById('api-temp').value = state.settings.temperature;
            document.getElementById('temp-val').innerText = state.settings.temperature;
            
            document.getElementById('feature-choices').checked = state.settings.enableChoices;
            document.getElementById('feature-statusbar').checked = state.settings.enableStatus;
            document.getElementById('feature-diffs').checked = state.settings.enableDiffs;
            document.getElementById('feature-summary').checked = state.settings.enableSummary;
            
            document.getElementById('mem-limit').value = state.settings.memLimit || 30; // Migrated to settings or state.memory? Let's use state.memory
            document.getElementById('mem-limit').value = state.memory.limit || 30; 
            document.getElementById('feature-auto-mem').checked = state.settings.enableAutoMem;
            document.getElementById('mem-interval').value = state.memory.interval;
            document.getElementById('mem-current').value = state.memory.current;
            
            document.getElementById('author-note-input').value = state.settings.authorNote;
        };

        function loadData() {
            const ls = localStorage.getItem('rpgStateV5');
            if (ls) {
                const parsed = JSON.parse(ls);
                state.settings = {...state.settings, ...parsed.settings};
                state.memory = {...state.memory, ...parsed.memory};
                state.content = {...state.content, ...parsed.content};
                if(parsed.messages) state.messages = parsed.messages;
                if(parsed.saves) state.saves = parsed.saves;
            }
        }
        function saveData() { localStorage.setItem('rpgStateV5', JSON.stringify(state)); }

        // --- Save System ---
        function createSave() {
            const name = prompt("å­˜æ¡£åç§°:", `å­˜æ¡£ ${state.saves.length+1}`);
            if(!name) return;
            const snapshot = JSON.parse(JSON.stringify(state)); delete snapshot.saves;
            state.saves.push({ id: Date.now(), name: name, date: new Date().toLocaleString(), data: snapshot });
            saveData(); renderSaves();
        }
        function loadSave(id) {
            if(!confirm("è¦†ç›–å½“å‰è¿›åº¦ï¼Ÿ")) return;
            const save = state.saves.find(s => s.id === id);
            if(save) {
                const savesBackup = state.saves;
                state.settings = save.data.settings;
                state.memory = save.data.memory;
                state.content = save.data.content;
                state.messages = save.data.messages;
                state.saves = savesBackup;
                saveData(); location.reload(); // Simple reload to refresh all UI
            }
        }
        function deleteSave(id) { if(!confirm("åˆ é™¤?")) return; state.saves = state.saves.filter(s => s.id !== id); saveData(); renderSaves(); }
        function renderSaves() {
            const c = document.getElementById('saves-container'); c.innerHTML = '';
            state.saves.forEach(s => {
                c.innerHTML += `<div class="list-item"><div class="list-info" onclick="loadSave(${s.id})"><div class="list-title">${s.name}</div><div class="list-desc">${s.date}</div></div><div class="delete-btn" onclick="deleteSave(${s.id})">ğŸ—‘ï¸</div></div>`;
            });
        }
        const originalOpenPage = openPage; openPage = function(id) { if(id==='page-saves') renderSaves(); originalOpenPage(id); }

        // --- Author & Memory ---
        function saveAuthorNote() { state.settings.authorNote = document.getElementById('author-note-input').value; saveData(); alert("Saved"); closePage('page-author-note'); }
        function saveMemorySettings() {
            state.memory.limit = parseInt(document.getElementById('mem-limit').value);
            state.settings.enableAutoMem = document.getElementById('feature-auto-mem').checked;
            state.memory.interval = parseInt(document.getElementById('mem-interval').value);
            state.memory.current = document.getElementById('mem-current').value;
            saveData(); alert("Memory Settings Saved");
        }

        // --- STREAMING LLM Logic ---
        async function handleSend(manual=null) {
            const inp = document.getElementById('user-input');
            const txt = manual || inp.value.trim();
            if(!txt) return;
            if(!manual) inp.value = '';
            if(!state.settings.apiKey) return alert("Missing API Key");

            appendMessage('user', txt);
            
            // Create Placeholder for AI Stream
            const aiDiv = document.createElement('div');
            aiDiv.className = 'message msg-ai typing-cursor';
            document.getElementById('game-container').appendChild(aiDiv);
            document.getElementById('game-container').scrollTop = 99999;
            
            state.memory.turnCount++;
            if(state.settings.enableAutoMem && state.memory.turnCount % state.memory.interval === 0) triggerSummary(true);
            saveData();

            try {
                await streamLLM(txt, aiDiv);
            } catch(e) {
                aiDiv.innerHTML += `\n[Error: ${e.message}]`;
            } finally {
                aiDiv.classList.remove('typing-cursor');
                // Format finalize
                const raw = aiDiv.innerText; // Get raw text
                aiDiv.innerHTML = formatMessageHTML(raw); // Apply formatting
                // Add events
                aiDiv.querySelectorAll('.choice-link').forEach(l=>{ l.onclick=(e)=>{e.stopPropagation(); handleSend(e.target.dataset.text);} });
                
                state.messages.push({role:'assistant', content:raw}); // Save Raw
                saveData();
            }
        }

        async function streamLLM(userInput, targetDiv) {
            const c = state.content;
            const wb = c.worldbooks.find(x => x.active);
            const persona = c.personas.find(x => x.active);
            const style = c.styles.find(x => x.active);
            const brk = c.breaks.find(x => x.active);
            const map = c.maps.find(x => x.active);
            const statbar = c.statusbars.find(x => x.active);
            const sumP = c.summary_prompts.find(x => x.active);
            const chars = c.characters.filter(x => x.active);
            const items = c.inventory.filter(x => x.active);

            let sys = "";
            if(wb) sys += `[World]\n${wb.content}\n\n`; else sys += "You are an RPG GM.\n";
            if(map) sys += `[Loc: ${map.name}]\n${map.content}\n\n`;
            if(chars.length) sys += `[NPCs]\n` + chars.map(x=>`- ${x.name}: ${x.bio} (Opinion:${x.opinion})`).join('\n') + "\n\n";
            if(items.length) sys += `[Inventory]\n` + items.map(x=>`- ${x.name}: ${x.desc}`).join('\n') + "\n\n";
            if(persona) sys += `[User Persona]\nName: ${persona.name}\n${persona.content}\n\n`;
            if(state.memory.current) sys += `[Memory]\n${state.memory.current}\n\n`;

            if(state.settings.enableStatus && statbar) {
                sys += `[INSTRUCTION: STATUS BAR]\nStart response with:\n${statbar.content}\nConstraint: Only update existing numbers inside [ ]. Do not add new rows.\n`;
            }

            if(state.settings.enableSummary && sumP) {
                sys += `[INSTRUCTION: SUMMARY]\nBefore choices, output a summary wrapped like this:\n###Summary###\n(Your summary here based on prompt: ${sumP.content})\n###EndSummary###\n`;
            }

            if(state.settings.enableDiffs) sys += `[INSTRUCTION: DIFFS]\nIf existing status values change, append '> Stat +Val' at line ends.\n`;
            if(state.settings.enableChoices) sys += `\nEnd with 4 numbered choices.\n`;
            if(style) sys += `[Style]\n${style.content}\n`;
            if(brk) sys += `[Override]\n${brk.content}\n`;
            if(state.settings.authorNote) sys += `\n[NOTE]\n${state.settings.authorNote}\n`;

            const msgs = [{role:"system", content: sys}, ...state.messages.slice(-state.memory.limit)];

            const response = await fetch(`${state.settings.apiUrl}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${state.settings.apiKey}` },
                body: JSON.stringify({
                    model: state.settings.model,
                    messages: msgs,
                    temperature: parseFloat(state.settings.temperature),
                    stream: true
                })
            });

            if(!response.ok) throw new Error("API Error");

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let buffer = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                buffer += chunk;
                
                const lines = buffer.split("\n");
                buffer = lines.pop(); // Keep last incomplete line

                for (const line of lines) {
                    if (line.trim() === "data: [DONE]") return;
                    if (line.startsWith("data: ")) {
                        try {
                            const json = JSON.parse(line.substring(6));
                            const txt = json.choices[0]?.delta?.content || "";
                            if (txt) {
                                targetDiv.innerText += txt; // Plain text stream
                                document.getElementById('game-container').scrollTop = 99999;
                            }
                        } catch (e) {}
                    }
                }
            }
        }

        function formatMessageHTML(raw) {
            let html = raw;
            // 1. Extract Summary Block
            html = html.replace(/###Summary###([\s\S]*?)###EndSummary###/gi, (match, content) => {
                return `<details><summary>æ‘˜è¦</summary><div class="summary-content">${content.trim()}</div></details>`;
            });

            // 2. Choices
            html = html.replace(/^(\d+\..+)$/gm, `<span class="choice-link" data-text="\$1">\$1</span>`);
            
            // 3. Diffs
            html = html.replace(/(^|\n)>\s*(.*?)([+-]\d+)(.*?)(\n|$)/g, (match, p1, label, num, suffix, p5) => {
                const isPos = num.startsWith('+');
                return `${p1}<span class="${isPos?'diff-pos':'diff-neg'}">> ${label}${num}${suffix}</span>${p5}`;
            });
            
            return html;
        }

        // --- Render Helpers ---
        function appendMessage(role, text) {
            const c = document.getElementById('game-container');
            const d = document.createElement('div');
            d.className = `message ${role==='user'?'msg-user':'msg-ai'}`;
            d.innerHTML = role==='user' ? '> '+text : formatMessageHTML(text);
            addLongPressEvent(d, state.messages.length);
            c.appendChild(d);
            c.scrollTop = c.scrollHeight;
            state.messages.push({role, content:text});
            if(role!=='user') d.querySelectorAll('.choice-link').forEach(l=>{ l.onclick=(e)=>{e.stopPropagation(); handleSend(e.target.dataset.text);} });
        }

        // --- AI Gen Logic (Same) ---
        async function generateAIContent() {
            if(!state.settings.apiKey) return alert("API Key Missing");
            const cat = state.ui.currentCategory;
            const promptType = CAT_CONFIG[cat].prompt;
            if(!promptType) return;
            const btn = document.getElementById('btn-ai-gen');
            btn.innerText = "Working..."; btn.disabled = true;
            try {
                const res = await fetch(`${state.settings.apiUrl}/chat/completions`, {method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${state.settings.apiKey}`},body:JSON.stringify({model:state.settings.model, messages:[{role:"system",content:"Return JSON."},{role:"user",content:`Create a ${promptType}. JSON Only.`}]})});
                const d = await res.json();
                const json = JSON.parse(d.choices[0].message.content.match(/\{[\s\S]*\}/)[0]);
                if(cat==='characters') { document.getElementById('field-name').value=json.name; document.getElementById('field-bio').value=json.bio; document.getElementById('field-personality').value=json.personality; }
                else if(cat==='inventory') { document.getElementById('field-name').value=json.name; document.getElementById('field-desc').value=json.desc; }
                else if(cat==='maps') { document.getElementById('field-content').value=json.content||d.choices[0].message.content; }
            } catch(e){alert("Error");} finally { btn.innerText="âœ¨ AI è‡ªåŠ¨ç”Ÿæˆ"; btn.disabled=false; }
        }

        // --- Shared UI Logic (Toggle Fix) ---
        function openList(category) { state.ui.currentCategory = category; document.getElementById('list-title').innerText = CAT_CONFIG[category].title; renderList(); openPage('page-list'); }
        function renderList() {
            const list = document.getElementById('list-container'); const cat = state.ui.currentCategory; const data = state.content[cat]; list.innerHTML = '';
            data.forEach((item, index) => {
                const div = document.createElement('div'); div.className = `list-item ${item.active ? 'active-item' : ''}`;
                div.innerHTML = `<div class="select-indicator" onclick="event.stopPropagation(); toggleActive('${cat}', ${index})"></div><div class="list-info" onclick="event.stopPropagation(); toggleActive('${cat}', ${index})"><div class="list-title">${item.name||'æœªå‘½å'}</div><div class="list-desc">${item.content||item.desc||item.bio||''}</div></div><div class="edit-btn" onclick="event.stopPropagation(); openEditor(${index})">âœ</div>`;
                list.appendChild(div);
            });
        }
        function toggleActive(category, index) {
            const type = CAT_CONFIG[category].type;
            const data = state.content[category];
            if (type === 'single') {
                // If clicking active item, deselect it. If clicking inactive, select it and deselect others.
                if(data[index].active) {
                    data[index].active = false;
                } else {
                    data.forEach(i => i.active = false);
                    data[index].active = true;
                }
            } else {
                data[index].active = !data[index].active;
            }
            saveData(); renderList();
        }
        function openEditor(index) {
            state.ui.editingId = index; const cat = state.ui.currentCategory; const fields = CAT_CONFIG[cat].fields; const c = document.getElementById('editor-fields'); c.innerHTML = '';
            document.getElementById('editor-title').innerText = (index===-1?'æ–°å»º':'ç¼–è¾‘') + CAT_CONFIG[cat].title;
            document.getElementById('btn-delete').style.display = index===-1 ? 'none':'block';
            document.getElementById('btn-ai-gen').style.display = CAT_CONFIG[cat].prompt ? 'flex' : 'none';
            const item = index !== -1 ? state.content[cat][index] : {};
            fields.forEach(f => {
                const w = document.createElement('div'); w.className='form-group';
                w.innerHTML = `<label class="form-label">${FIELD_LABELS[f]||f}</label>`;
                const input = (f==='name'||f==='personality'||f==='opinion') ? document.createElement('input') : document.createElement('textarea');
                input.className = input.tagName==='INPUT'?'form-input':'form-textarea';
                if(f==='content') input.style.height = '150px';
                input.id = `field-${f}`; input.value = item[f] || '';
                w.appendChild(input); c.appendChild(w);
            });
            openPage('page-editor');
        }
        function saveEntry() {
            const cat = state.ui.currentCategory; const entry = {};
            CAT_CONFIG[cat].fields.forEach(f => entry[f] = document.getElementById(`field-${f}`).value);
            entry.active = state.ui.editingId !== -1 ? state.content[cat][state.ui.editingId].active : false;
            if(state.ui.editingId === -1) state.content[cat].push(entry); else state.content[cat][state.ui.editingId] = entry;
            saveData(); renderList(); closePage('page-editor');
        }
        function deleteEntry() { if(!confirm("åˆ é™¤?")) return; state.content[state.ui.currentCategory].splice(state.ui.editingId, 1); saveData(); renderList(); closePage('page-editor'); }

        // --- Standard Logic ---
        function saveApiSettings() { 
            state.settings.apiUrl = document.getElementById('api-url').value.replace(/\/$/, "");
            state.settings.apiKey = document.getElementById('api-key').value;
            state.settings.temperature = document.getElementById('api-temp').value;
            const m = document.getElementById('api-model').value; if(m) state.settings.model=m;
            saveData(); alert("Saved"); closePage('page-api');
        }
        function saveFeatureSettings() {
            state.settings.enableChoices = document.getElementById('feature-choices').checked;
            state.settings.enableStatus = document.getElementById('feature-statusbar').checked;
            state.settings.enableDiffs = document.getElementById('feature-diffs').checked;
            state.settings.enableSummary = document.getElementById('feature-summary').checked;
            saveData(); alert("Saved"); closePage('page-features');
        }
        async function fetchModels() {
            try { const r = await fetch(`${document.getElementById('api-url').value.replace(/\/$/,"")}/models`, {headers:{'Authorization':`Bearer ${document.getElementById('api-key').value}`}}); const d = await r.json(); const s = document.getElementById('api-model'); s.innerHTML=''; d.data.forEach(m=>{const o=document.createElement('option'); o.value=m.id; o.innerText=m.id; s.appendChild(o)}); alert("OK"); } catch(e){alert(e.message);}
        }
        function reRenderChat() { document.getElementById('game-container').innerHTML = ''; const temp = [...state.messages]; state.messages = []; temp.forEach(m => appendMessage(m.role, m.content)); }
        function resetStory() { if(!confirm("Reset?")) return; state.messages = []; state.memory.current = ""; saveData(); reRenderChat(); toggleSidebar(); appendMessage('assistant', 'Reset done.'); }
        
        function toggleSidebar() { document.querySelector('.sidebar').classList.toggle('open'); document.querySelector('.sidebar-overlay').classList.toggle('open'); }
        function openPage(id) { document.getElementById(id).classList.add('active'); if(document.querySelector('.sidebar').classList.contains('open')) toggleSidebar(); }
        function closePage(id) { document.getElementById(id).classList.remove('active'); }
        function addLongPressEvent(el, idx) {
            el.addEventListener('touchstart', (e)=>{ state.ui.longPressTimer = setTimeout(()=>openActionSheet(idx),800); },{passive:true});
            const c = () => clearTimeout(state.ui.longPressTimer);
            el.addEventListener('touchend', c); el.addEventListener('touchmove', c);
            el.addEventListener('contextmenu', (e)=>{ e.preventDefault(); openActionSheet(idx); });
        }
        function openActionSheet(i) { state.ui.selectedMsgIndex = i; document.getElementById('action-sheet').classList.add('open'); if(navigator.vibrate)navigator.vibrate(50); }
        function closeActionSheet() { document.getElementById('action-sheet').classList.remove('open'); }
        function actionDelete() { state.messages.splice(state.ui.selectedMsgIndex, 1); reRenderChat(); saveData(); closeActionSheet(); }
        function actionEdit() { document.getElementById('edit-msg-textarea').value = state.messages[state.ui.selectedMsgIndex].content; document.getElementById('edit-modal').classList.add('active'); closeActionSheet(); }
        function closeEditModal() { document.getElementById('edit-modal').classList.remove('active'); }
        function confirmMsgEdit() { state.messages[state.ui.selectedMsgIndex].content = document.getElementById('edit-msg-textarea').value; reRenderChat(); saveData(); closeEditModal(); }
        async function actionRegenerate() {
            const idx = state.ui.selectedMsgIndex; closeActionSheet();
            if(state.messages[idx].role === 'assistant') state.messages.splice(idx, 1); else state.messages.splice(idx+1);
            reRenderChat(); saveData(); 
            // Trigger stream logic manually by faking user send but without appending user message
            // Wait, streamLLM needs a prompt. We grab the last user message.
            const lastUserMsg = state.messages.length > 0 ? state.messages[state.messages.length-1] : {content:""};
            if(lastUserMsg.role === 'user') {
                const aiDiv = document.createElement('div'); aiDiv.className = 'message msg-ai typing-cursor';
                document.getElementById('game-container').appendChild(aiDiv);
                try { await streamLLM(lastUserMsg.content, aiDiv); } finally { aiDiv.classList.remove('typing-cursor'); aiDiv.innerHTML = formatMessageHTML(aiDiv.innerText); state.messages.push({role:'assistant', content:aiDiv.innerText}); saveData(); }
            }
        }
        async function triggerSummary(silent=false) {
            if(!state.settings.apiKey) return;
            if(!silent) document.querySelector('button[onclick="triggerSummary()"]').innerText="Working...";
            // Get Active Strategy
            const strat = state.content.mem_prompts.find(x=>x.active) || {content:"Summarize."};
            try {
                const r = await fetch(`${state.settings.apiUrl}/chat/completions`, {method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${state.settings.apiKey}`},body:JSON.stringify({model:state.settings.model, messages:[{role:'user',content:`Old Memory:\n${state.memory.current}\n\nNew Events:\n${state.messages.slice(-20).map(m=>m.content).join('\n')}\n\nTask: ${strat.content} Append to old memory.`}]})});
                const d = await r.json(); 
                const newSum = d.choices[0].message.content;
                // Append logic as requested
                state.memory.current = (state.memory.current + "\n\n" + newSum).trim();
                document.getElementById('mem-current').value = state.memory.current; 
                saveData();
                if(!silent) { alert("Done"); document.querySelector('button[onclick="triggerSummary()"]').innerText="âš¡ ç«‹å³è¿›è¡Œè®°å¿†æ€»ç»“ (è¿½åŠ )"; }
            } catch(e){}
        }
    </script>
</body>
</html>