<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI Text RPG V11</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --bg-color: #000000;
            --text-user: #888888;
            --text-ai: #ffffff;
            --text-link: #4A90E2;
            --ui-bg: #1C1C1E;
            --ui-border: #333;
            --accent: #0A84FF;
            --danger: #FF453A;
            --success: #30D158;
            --select-bg: rgba(10, 132, 255, 0.2);
            --select-border: #0A84FF;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-ai);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* --- Header --- */
        .header {
            position: fixed; top: 0; left: 0; width: 100%; height: 50px;
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 15px; z-index: 100;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), rgba(0,0,0,0));
            pointer-events: none;
        }
        .header > * { pointer-events: auto; }
        
        .icon-btn {
            background: rgba(28, 28, 30, 0.8); border: 1px solid #333; cursor: pointer; padding: 8px;
            color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(10px);
        }
        .icon-btn:active { background-color: rgba(255,255,255,0.2); }

        /* --- Chat Area --- */
        #game-container {
            flex: 1; overflow-y: auto; padding: 60px 20px 100px 20px;
            display: flex; flex-direction: column; gap: 15px;
            scroll-behavior: smooth; 
        }
        
        .message { 
            line-height: 1.6; font-size: 16px; user-select: text; 
            padding: 8px; border-radius: 8px; border: 1px solid transparent; transition: all 0.2s;
        }
        .message.selected { background-color: var(--select-bg); border-color: var(--select-border); }
        .msg-user { color: var(--text-user); }
        .msg-ai { color: var(--text-ai); }

        /* Markdown Overrides */
        .message p { margin: 0 0 10px 0; }
        .message p:last-child { margin-bottom: 0; }
        .message strong { color: #fff; font-weight: 800; text-shadow: 0 0 5px rgba(255,255,255,0.2); }
        .message em { color: #ccc; font-style: italic; }
        .message h1, .message h2, .message h3 { margin: 10px 0 5px 0; font-size: 1.1em; color: var(--accent); }
        
        /* Lists (Standard - Unclickable) */
        .message ol, .message ul { padding-left: 25px; margin: 5px 0; color: var(--text-ai); }
        .message li { margin-bottom: 5px; cursor: default; }

        /* Custom Choice Link (Blue, Clickable) */
        .choice-btn {
            display: block; margin: 6px 0; color: var(--text-link); 
            text-decoration: none; cursor: pointer; width: fit-content;
        }
        .choice-btn:active { opacity: 0.7; }

        /* Summary */
        details { background: #111; padding: 10px; border-radius: 8px; margin: 10px 0; border: 1px solid #333; }
        summary { color: #888; cursor: pointer; font-size: 14px; font-weight: bold; list-style: none; }
        summary::-webkit-details-marker { display: none; }
        summary::before { content: "â–¶ "; display: inline-block; margin-right: 5px; transition: transform 0.2s; }
        details[open] summary::before { transform: rotate(90deg); }
        .summary-content { font-size: 14px; color: #aaa; margin-top: 10px; font-style: italic; }
        
        .typing-cursor::after { content: "â–‹"; animation: blink 1s infinite; color: var(--accent); }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        .load-more-container { display: flex; justify-content: center; margin-bottom: 10px; }
        .load-more-btn { background: #333; color: #ccc; border: none; padding: 5px 15px; border-radius: 15px; font-size: 12px; cursor: pointer; }

        .scroll-down-btn {
            position: fixed; bottom: 90px; right: 20px;
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(28, 28, 30, 0.9); border: 1px solid #444;
            color: var(--accent); display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 90;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .scroll-down-btn.visible { opacity: 1; pointer-events: auto; }

        /* --- Input Area --- */
        .input-area {
            position: fixed; bottom: 0; left: 0; width: 100%;
            padding: 10px 15px; background-color: var(--bg-color);
            display: flex; gap: 10px; border-top: 1px solid #333; z-index: 50;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }
        #user-input { flex: 1; background: #1C1C1E; border: none; border-radius: 20px; padding: 10px 15px; color: white; font-size: 16px; outline: none; }
        #send-btn { background: var(--accent); color: white; border: none; border-radius: 20px; padding: 0 20px; font-weight: bold; cursor: pointer; }

        /* --- Selection Toolbar --- */
        .selection-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            padding: 15px 25px; background-color: #1C1C1E; border-top: 1px solid #333; 
            z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .selection-bar.active { transform: translateY(0); }
        .toolbar-btn { background: none; border: none; color: white; font-size: 14px; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; }
        .toolbar-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .toolbar-btn.destructive { color: var(--danger); }

        /* --- Sidebar & Modals --- */
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .sidebar { position: fixed; top: 0; left: 0; width: 85%; max-width: 320px; height: 100%; background-color: var(--ui-bg); z-index: 201; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1); padding: 20px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; box-shadow: 2px 0 10px rgba(0,0,0,0.5); }
        .sidebar.open { transform: translateX(0); }
        .sidebar-overlay.open { opacity: 1; pointer-events: auto; }
        .sidebar-title { font-size: 22px; font-weight: bold; margin: 10px 0 20px 0; padding-left: 10px; }
        .menu-category { font-size: 12px; color: #666; margin: 15px 0 5px 10px; text-transform: uppercase; letter-spacing: 1px; }
        .menu-item { display: flex; align-items: center; gap: 15px; padding: 12px 15px; background: #2C2C2E; border-radius: 10px; cursor: pointer; transition: background 0.2s; }
        .menu-item:active { background: #3A3A3C; }
        .menu-item svg { width: 20px; height: 20px; color: var(--accent); }
        .menu-item.danger { color: var(--danger); border: 1px solid rgba(255, 69, 58, 0.3); }
        .menu-item.danger svg { color: var(--danger); }

        .page-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 300; transform: translateX(100%); transition: transform 0.3s; display: flex; flex-direction: column; }
        .page-modal.active { transform: translateX(0); }
        .page-header { padding: 15px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #333; background: var(--ui-bg); padding-top: calc(15px + env(safe-area-inset-top)); }
        .page-content { padding: 20px; overflow-y: auto; flex: 1; }

        .center-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 400; opacity: 0; pointer-events: none; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s; }
        .center-modal-overlay.active { opacity: 1; pointer-events: auto; }
        .center-modal { width: 85%; max-width: 320px; background: #2C2C2E; border-radius: 20px; padding: 20px; transform: scale(0.9); transition: transform 0.2s; display: flex; flex-direction: column; gap: 15px; }
        .center-modal-overlay.active .center-modal { transform: scale(1); }
        .center-modal h3 { margin: 0; text-align: center; }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; color: #888; margin-bottom: 8px; font-size: 14px; }
        .form-input, .form-textarea, .form-select { width: 100%; background: #1C1C1E; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; font-size: 16px; outline: none; }
        .form-textarea { height: 120px; resize: none; }
        .btn-primary { width: 100%; background: var(--accent); color: white; border: none; padding: 14px; border-radius: 12px; font-size: 16px; font-weight: bold; margin-top: 10px; }
        .btn-secondary { background: #333; color: white; border: none; padding: 10px; border-radius: 8px; font-size: 14px; margin-top: 5px; width: 100%; }
        .btn-ai { background: linear-gradient(135deg, #0A84FF, #5E5CE6); color: white; border: none; padding: 10px; border-radius: 8px; font-size: 14px; margin-bottom: 10px; width: 100%; display:flex; justify-content: center; align-items: center; gap: 5px;}
        
        .list-item { background: #1C1C1E; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; cursor: pointer; border: 1px solid transparent; }
        .list-item.active-item { border-color: rgba(48, 209, 88, 0.3); background: #232325; }
        
        .select-indicator { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #555; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; }
        .active-item .select-indicator { border-color: var(--success); background-color: var(--success); }
        .active-item .select-indicator::after { content: "âœ“"; color: #000; font-weight: bold; font-size: 14px; }
        
        .list-info { flex: 1; overflow: hidden; }
        .list-title { font-weight: bold; font-size: 16px; margin-bottom: 4px; }
        .list-desc { color: #888; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .edit-btn { padding: 8px; color: var(--accent); z-index: 2; }
        .delete-btn { padding: 8px; color: var(--danger); z-index: 2; font-size: 18px; font-weight: bold;}

        .toggle-row { display: flex; justify-content: space-between; align-items: center; background: #1C1C1E; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 30px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(20px); }
        .range-slider { width: 100%; -webkit-appearance: none; background: #333; height: 5px; border-radius: 5px; outline: none; }
        .range-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: var(--accent); border-radius: 50%; cursor: pointer; }

        .stats-panel { background: #2C2C2E; border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; color: #ccc; font-size: 14px; }
        .stat-row:last-child { margin-bottom: 0; }
        .stat-value { font-family: monospace; color: var(--accent); }

    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <button class="icon-btn" onclick="toggleSidebar()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
        <button class="icon-btn" onclick="toggleSelectionMode()" id="select-mode-btn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
        </button>
    </div>

    <!-- Main Game Area -->
    <div id="game-container"></div>

    <!-- Floating Scroll To Bottom Button -->
    <button class="scroll-down-btn" id="scroll-btn" onclick="scrollToBottom()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 13l5 5 5-5M7 6l5 5 5-5"/></svg>
    </button>

    <!-- Input Area -->
    <div class="input-area" id="main-input-area">
        <input type="text" id="user-input" placeholder="è¾“å…¥è¡ŒåŠ¨...">
        <button id="send-btn" onclick="handleSend()">å‘é€</button>
    </div>

    <!-- Selection Toolbar -->
    <div class="selection-bar" id="selection-bar">
        <button class="toolbar-btn" id="tool-edit" onclick="actionEdit()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg> ç¼–è¾‘
        </button>
        <button class="toolbar-btn" id="tool-regen" onclick="actionRegenerate()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg> é‡æ¥
        </button>
        <button class="toolbar-btn destructive" id="tool-delete" onclick="actionDelete()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg> åˆ é™¤
        </button>
        <button class="toolbar-btn" onclick="toggleSelectionMode()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg> å–æ¶ˆ
        </button>
    </div>

    <!-- Sidebar -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar">
        <div class="sidebar-title">RPG V11 æ§åˆ¶å°</div>
        
        <div class="menu-category">æ ¸å¿ƒåŠŸèƒ½</div>
        <div class="menu-item" onclick="openPage('page-save')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
            <span> å­˜æ¡£ </span>
        </div>
        <div class="menu-item" onclick="openPage('page-load')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 15a9 9 0 0 1-14.85-3.36L1 14"></path><path d="M23 4v6h-6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path></svg>
            <span> è¯»æ¡£ </span>
        </div>
        <div class="menu-item" onclick="openScenarioModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
            <span> æƒ…æ™¯è®°å¿† </span>
        </div>
        <div class="menu-item" onclick="openPage('page-memory-hub')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
            <span> è®°å¿† </span>
        </div>

        <div class="menu-category">æ•°æ®</div>
        <div class="menu-item" onclick="openPage('page-content-hub')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
            <span>ä¸–ç•Œæ•°æ®ç®¡ç†</span>
        </div>
        
        <div class="menu-category">ç³»ç»Ÿ</div>
        <div class="menu-item" onclick="openPage('page-backup')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 16 12 12 8 16"></polyline><line x1="12" y1="12" x2="12" y2="21"></line><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"></path><polyline points="16 16 12 12 8 16"></polyline></svg>
            <span> å¤‡ä»½ä¸è¿˜åŸ </span>
        </div>
        <div class="menu-item" onclick="openPage('page-api')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
            <span>API è®¾ç½®</span>
        </div>
        <div class="menu-item" onclick="openPage('page-features')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            <span>åŠŸèƒ½è®¾ç½®</span>
        </div>
        
        <div class="menu-category" style="margin-top: 30px;">å±é™©åŒºåŸŸ</div>
        <div class="menu-item danger" onclick="resetStory()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            <span>æ¸…ç©ºå½“å‰å‰§æƒ…</span>
        </div>
    </div>

    <!-- ================= MODALS & PAGES ================= -->

    <!-- Scenario Memory Modal -->
    <div id="modal-scenario" class="center-modal-overlay">
        <div class="center-modal">
            <h3>æƒ…æ™¯è®°å¿†</h3>
            <p style="font-size:12px; color:#888; text-align:center; margin:0;">å¼ºæ•ˆæŒ‡ä»¤ï¼Œæ’å…¥ Prompt æœ«å°¾ã€‚</p>
            <textarea id="scenario-input" class="form-textarea" style="height:150px" placeholder="è¾“å…¥æƒ…æ™¯è®°å¿†..."></textarea>
            <div style="display:flex; gap:10px;">
                <button class="btn-secondary" onclick="closeScenarioModal()">å–æ¶ˆ</button>
                <button class="btn-primary" style="margin-top:5px" onclick="saveScenario()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Page: Backup & Restore -->
    <div id="page-backup" class="page-modal">
        <div class="page-header">
            <button class="icon-btn" onclick="closePage('page-backup')"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></button>
            <h3>å¤‡ä»½ä¸è¿˜åŸ</h3>
        </div>
        <div class="page-content">
            <div class="stats-panel">
                <div style="font-weight:bold; margin-bottom:10px; color:white;">å­˜å‚¨å ç”¨</div>
                <div id="storage-stats"><div class="loading">æ­£åœ¨è®¡ç®—...</div></div>
            </div>
            <div style="background:#1C1C1E; padding:15px; border-radius:12px; margin-bottom:20px;">
                <div style="font-weight:bold; margin-bottom:5px; color:var(--success);">å¯¼å‡º</div>
                <p style="font-size:12px; color:#888; margin-bottom:10px;">ä¸‹è½½åŒ…å«æ‰€æœ‰æ•°æ®çš„ JSON æ–‡ä»¶ã€‚</p>
                <button class="btn-primary" style="background:#2C2C2E; border:1px solid #444;" onclick="exportData()">â¬‡ï¸ å¯¼å‡ºä¸–ç•Œæ•°æ®</button>
            </div>
            <div style="background:#1C1C1E; padding:15px; border-radius:12px;">
                <div style="font-weight:bold; margin-bottom:5px; color:var(--accent);">å¯¼å…¥</div>
                <p style="font-size:12px; color:#888; margin-bottom:10px;">è¯»å– JSON æ–‡ä»¶å¹¶è¦†ç›–å½“å‰æ•°æ®ã€‚</p>
                <input type="file" id="import-file" style="display:none" onchange="importData(this)">
                <button class="btn-primary" onclick="document.getElementById('import-file').click()">â¬†ï¸ å¯¼å…¥ä¸–ç•Œæ•°æ®</button>
            </div>
        </div>
    </div>

    <!-- Page: Memory System -->
    <div id="page-memory-hub" class="page-modal">
        <div class="page-header">
            <button class="icon-btn" onclick="closePage('page-memory-hub')"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></button>
            <h3> è®°å¿†</h3>
        </div>
        <div class="page-content">
            <div class="form-group"><label class="form-label">è®°å¿†ä¸Šé™</label><input type="number" id="mem-limit" class="form-input" value="30"></div>
            <div class="toggle-row"><span>è‡ªåŠ¨è®°å¿†æ€»ç»“</span><label class="switch"><input type="checkbox" id="feature-auto-mem"><span class="slider"></span></label></div>
            <div class="form-group"><label class="form-label">è‡ªåŠ¨æ€»ç»“é—´éš”</label><input type="number" id="mem-interval" class="form-input" value="20"></div>
            <div class="menu-item" style="margin-bottom:15px; background:#2C2C2E;" onclick="openList('mem_prompts')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path></svg><span>æ€»ç»“æç¤ºè¯ç­–ç•¥</span>
            </div>
            <hr style="border:1px solid #333; margin:20px 0;">
            <div class="form-group"><label class="form-label">é•¿æ—¶è®°å¿†</label><textarea id="mem-current" class="form-textarea" style="height:150px" placeholder="AI é•¿æœŸè®°å¿†..."></textarea></div>
            <button class="btn-ai" onclick="triggerSummary()"> ç«‹å³è¿›è¡Œè®°å¿†æ€»ç»“</button>
            <button class="btn-primary" onclick="saveMemorySettings()">ä¿å­˜è®°å¿†è®¾ç½®</button>
        </div>
    </div>

    <!-- Page: Content Hub -->
    <div id="page-content-hub" class="page-modal">
        <div class="page-header">
            <button class="icon-btn" onclick="closePage('page-content-hub')"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></button>
            <h3>ä¸–ç•Œæ•°æ®ç®¡ç†</h3>
        </div>
        <div class="page-content">
            <div class="menu-item" onclick="openList('worldbooks')"><span> ä¸–ç•Œä¹¦</span></div>
            <div class="menu-item" style="margin-top:10px" onclick="openList('statusbars')"><span> çŠ¶æ€æ æ¨¡æ¿ (V2)</span></div>
            <div class="menu-item" style="margin-top:10px" onclick="openList('personas')"><span> User äººè®¾</span></div>
            <div class="menu-item" style="margin-top:10px" onclick="openList('styles')"><span> æ–‡é£è®¾ç½®</span></div>
            <div class="menu-item" style="margin-top:10px" onclick="openList('breaks')"><span> ç ´é™ / é«˜çº§æŒ‡ä»¤</span></div>
            <div class="menu-item" style="margin-top:10px" onclick="openList('summary_prompts')"><span> æ‘˜è¦æç¤ºè¯</span></div>
            <div style="height:1px; background:#333; margin:20px 0;"></div>
            <div class="menu-item" onclick="openList('maps')"><span>ğŸ—ºï¸ åœ°å›¾</span></div>
            <div class="menu-item" style="margin-top:10px" onclick="openList('characters')"><span> äººç‰©</span></div>
            <div class="menu-item" style="margin-top:10px" onclick="openList('inventory')"><span> ç‰©å“</span></div>
        </div>
    </div>

    <!-- Page: Save -->
    <div id="page-save" class="page-modal">
        <div class="page-header"><button class="icon-btn" onclick="closePage('page-save')"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></button><h3>ğŸ’¾ å­˜æ¡£</h3><button class="icon-btn" style="margin-left:auto; color:var(--accent)" onclick="createSave()">+</button></div>
        <div class="page-content"><p style="font-size:12px; color:#666; margin-bottom:10px;">ç‚¹å‡»ç°æœ‰å­˜æ¡£å¯è¦†ç›–ã€‚</p><div id="save-list-container"></div></div>
    </div>

    <!-- Page: Load -->
    <div id="page-load" class="page-modal">
        <div class="page-header"><button class="icon-btn" onclick="closePage('page-load')"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></button><h3>ğŸ“‚ è¯»æ¡£</h3></div>
        <div class="page-content"><p style="font-size:12px; color:#666; margin-bottom:10px;">ç‚¹å‡»å­˜æ¡£è¯»å–ã€‚</p><div id="load-list-container"></div></div>
    </div>

    <!-- Generic List Page -->
    <div id="page-list" class="page-modal">
        <div class="page-header"><button class="icon-btn" onclick="closePage('page-list')"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></button><h3 id="list-title">åˆ—è¡¨</h3><button class="icon-btn" style="margin-left:auto; color:var(--accent)" onclick="openEditor(-1)">+</button></div>
        <div class="page-content"><div style="font-size:12px; color:#666; margin-bottom:10px;">ç‚¹å‡»åœ†åœˆåˆ‡æ¢çŠ¶æ€ (ç»¿è‰²å®å¿ƒ=ç”Ÿæ•ˆ)</div><div id="list-container"></div></div>
    </div>

    <!-- Generic Editor Page -->
    <div id="page-editor" class="page-modal" style="z-index:310;">
        <div class="page-header"><button class="icon-btn" onclick="closePage('page-editor')">å–æ¶ˆ</button><h3 id="editor-title">ç¼–è¾‘</h3></div>
        <div class="page-content"><button id="btn-ai-gen" class="btn-ai" style="display:none" onclick="generateAIContent()">âœ¨ AI è‡ªåŠ¨ç”Ÿæˆ</button><div id="editor-fields"></div><button class="btn-primary" onclick="saveEntry()">ä¿å­˜</button><button class="btn-secondary btn-danger" onclick="deleteEntry()" id="btn-delete">åˆ é™¤</button></div>
    </div>

    <!-- Page: API Settings -->
    <div id="page-api" class="page-modal">
        <div class="page-header"><button class="icon-btn" onclick="closePage('page-api')"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></button><h3>API è®¾ç½®</h3></div>
        <div class="page-content">
            <div class="form-group"><label class="form-label">API Base URL</label><input type="text" id="api-url" class="form-input" placeholder="https://api.openai.com/v1"></div>
            <div class="form-group"><label class="form-label">API Key</label><input type="password" id="api-key" class="form-input" placeholder="sk-..."></div>
            <div class="form-group"><label class="form-label">Temperature: <span id="temp-val">1.0</span></label><input type="range" id="api-temp" class="range-slider" min="0" max="2" step="0.1" value="1.0" oninput="document.getElementById('temp-val').innerText=this.value"></div>
            <button class="btn-secondary" onclick="fetchModels()">æ‹‰å–æ¨¡å‹åˆ—è¡¨</button>
            <div class="form-group" style="margin-top:10px;"><label class="form-label">é€‰æ‹©æ¨¡å‹</label><select id="api-model" class="form-select"></select></div>
            <button class="btn-primary" onclick="saveApiSettings()">ä¿å­˜é…ç½®</button>
        </div>
    </div>

    <!-- Page: Features -->
    <div id="page-features" class="page-modal">
        <div class="page-header"><button class="icon-btn" onclick="closePage('page-features')"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg></button><h3>åŠŸèƒ½è®¾ç½®</h3></div>
        <div class="page-content">
            <div class="toggle-row"><span>å‰§æƒ…é€‰æ‹©å¼€å…³</span><label class="switch"><input type="checkbox" id="feature-choices"><span class="slider"></span></label></div>
            <div class="toggle-row"><span>çŠ¶æ€æ å¼€å…³</span><label class="switch"><input type="checkbox" id="feature-statusbar"><span class="slider"></span></label></div>
            
            <div class="toggle-row" style="margin-bottom:5px; border-bottom-left-radius:0; border-bottom-right-radius:0;">
                <span>æ•°å€¼å˜åŒ–æç¤ºå¼€å…³</span><label class="switch"><input type="checkbox" id="feature-diffs" onchange="toggleDiffConfig()"><span class="slider"></span></label>
            </div>
            <div id="diff-config-area" style="background:#1C1C1E; padding:15px; border-bottom-left-radius:12px; border-bottom-right-radius:12px; margin-bottom:15px; display:none;">
                <label class="form-label">æ•°å€¼å˜åŒ–è‡ªå®šä¹‰æŒ‡ä»¤ (Custom Style)</label>
                <textarea id="diff-style-input" class="form-textarea" placeholder="ä¾‹å¦‚ï¼šè¯·ç”¨ç²—ä½“çº¢è‰²è¡¨ç¤ºæ‰£è¡€ï¼Œç²—ä½“ç»¿è‰²è¡¨ç¤ºå›è¡€ã€‚"></textarea>
            </div>

            <div class="toggle-row"><span>æŠ˜å æ‘˜è¦å¼€å…³</span><label class="switch"><input type="checkbox" id="feature-summary"><span class="slider"></span></label></div>
            <button class="btn-primary" onclick="saveFeatureSettings()">ä¿å­˜è®¾ç½®</button>
        </div>
    </div>

    <!-- Edit Msg Modal -->
    <div id="edit-modal" class="page-modal" style="z-index: 600;">
        <div class="page-header"><button class="icon-btn" onclick="closeEditModal()">å–æ¶ˆ</button><h3>ç¼–è¾‘å†…å®¹</h3></div>
        <div class="page-content"><textarea id="edit-msg-textarea" class="form-textarea" style="height: 300px;"></textarea><button class="btn-primary" onclick="confirmMsgEdit()">ç¡®è®¤ä¿®æ”¹</button></div>
    </div>

    <!-- Action Sheet -->
    <div id="action-sheet" class="action-sheet-overlay" onclick="closeActionSheet()">
        <div class="action-menu" onclick="event.stopPropagation()">
       
        </div>
    </div>

    <script>
        // Configure Marked
        marked.setOptions({ breaks: true });

        const state = {
            messages: [],
            settings: {
                apiUrl: "https://api.openai.com/v1", apiKey: "", model: "gpt-3.5-turbo", temperature: 1.0,
                enableChoices: true, enableStatus: true, enableDiffs: true, enableSummary: true, enableAutoMem: false,
                authorNote: "",
                diffStyle: "" // New: Custom instruction for diffs
            },
            memory: { limit: 30, interval: 20, current: "", turnCount: 0 },
            content: {
                worldbooks: [], personas: [], styles: [], breaks: [], statusbars: [],
                summary_prompts: [], mem_prompts: [], maps: [], characters: [], inventory: []   
            },
            saves: [],
            ui: { 
                currentCategory: '', editingId: -1, 
                selectionMode: false, selectedIndices: new Set(),
                visibleMsgCount: 40 
            }
        };

        // Added 'instruction' to statusbars
        const CAT_CONFIG = {
            worldbooks: { title: "ä¸–ç•Œä¹¦", type: "single", fields: ['name', 'content'], prompt: "world setting" },
            statusbars: { title: "çŠ¶æ€æ æ¨¡æ¿", type: "single", fields: ['name', 'content', 'instruction'], prompt: null },
            personas:   { title: "Useräººè®¾", type: "single", fields: ['name', 'content'], prompt: null },
            styles:     { title: "æ–‡é£", type: "multi", fields: ['name', 'content'], prompt: null },
            breaks:     { title: "ç ´é™/æŒ‡ä»¤", type: "multi", fields: ['name', 'content'], prompt: null },
            summary_prompts: { title: "æ‘˜è¦æç¤ºè¯", type: "single", fields: ['name', 'content'], prompt: null },
            mem_prompts:     { title: "è®°å¿†æ€»ç»“ç­–ç•¥", type: "single", fields: ['name', 'content'], prompt: null },
            maps:       { title: "åœ°å›¾", type: "single", fields: ['name', 'content'], prompt: "map description" },
            characters: { title: "äººç‰©", type: "multi",  fields: ['name', 'bio', 'personality', 'opinion', 'memory'], prompt: "character" },
            inventory:  { title: "ç‰©å“", type: "multi",  fields: ['name', 'desc'], prompt: "item" }
        };
        const FIELD_LABELS = { name: "åç§°", content: "å†…å®¹/æ¨¡æ¿", instruction: "AIæŒ‡ä»¤(éšè—)", desc: "ä»‹ç»", bio: "åŸºæœ¬ä»‹ç»", personality: "æ€§æ ¼", opinion: "å¯¹Userçœ‹æ³•", memory: "é‡è¦è®°å¿†" };

        window.onload = () => {
            loadData();
            if(state.content.styles.length===0) state.content.styles.push({name:"é»˜è®¤",content:"",active:true});
            if(state.content.statusbars.length===0) state.content.statusbars.push({name:"é»˜è®¤RPG",content:"çŠ¶æ€æ ï¼š\n[HP]: 100/100\n[é‡‘å¸]: 0", instruction:"Update values in brackets based on context.", active:true});
            if(state.content.summary_prompts.length===0) state.content.summary_prompts.push({name:"é»˜è®¤æ‘˜è¦",content:"è¯·ç”¨50å­—ä»¥å†…æ€»ç»“æœ¬æ®µå‰§æƒ…ã€‚",active:true});
            if(state.content.mem_prompts.length===0) state.content.mem_prompts.push({name:"é»˜è®¤ç­–ç•¥",content:"è¯·æ€»ç»“ä¹‹å‰å‰§æƒ…çš„å…³é”®è¿›å±•ã€‚",active:true});

            if(state.messages.length === 0) appendMessage('assistant', 'V11 ç³»ç»Ÿå°±ç»ªã€‚');
            else reRenderChat();
            
            document.getElementById('api-url').value = state.settings.apiUrl;
            document.getElementById('api-key').value = state.settings.apiKey;
            document.getElementById('api-temp').value = state.settings.temperature;
            document.getElementById('temp-val').innerText = state.settings.temperature;
            
            document.getElementById('feature-choices').checked = state.settings.enableChoices;
            document.getElementById('feature-statusbar').checked = state.settings.enableStatus;
            document.getElementById('feature-diffs').checked = state.settings.enableDiffs;
            document.getElementById('feature-summary').checked = state.settings.enableSummary;
            document.getElementById('diff-style-input').value = state.settings.diffStyle || "";
            toggleDiffConfig(); // Show/hide textarea based on toggle

            document.getElementById('mem-limit').value = state.memory.limit || 30; 
            document.getElementById('feature-auto-mem').checked = state.settings.enableAutoMem;
            document.getElementById('mem-interval').value = state.memory.interval;
            document.getElementById('mem-current').value = state.memory.current;
            
            document.getElementById('game-container').addEventListener('scroll', handleScroll);
        };

        function loadData() {
            const ls = localStorage.getItem('rpgStateV11'); // New Key
            if (ls) {
                const parsed = JSON.parse(ls);
                state.settings = {...state.settings, ...parsed.settings};
                state.memory = {...state.memory, ...parsed.memory};
                state.content = {...state.content, ...parsed.content};
                if(parsed.messages) state.messages = parsed.messages;
                if(parsed.saves) state.saves = parsed.saves;
            }
        }
        function saveData() { localStorage.setItem('rpgStateV11', JSON.stringify(state)); }

        // --- Import / Export ---
        function renderStorageStats() {
            const sizeChat = new Blob([JSON.stringify(state.messages)]).size;
            const sizeSaves = new Blob([JSON.stringify(state.saves)]).size;
            const sizeContent = new Blob([JSON.stringify(state.content)]).size;
            const sizeMem = new Blob([JSON.stringify(state.memory)]).size;
            const total = sizeChat + sizeSaves + sizeContent + sizeMem;
            const fmt = (b) => (b/1024).toFixed(2) + ' KB';
            document.getElementById('storage-stats').innerHTML = `<div class="stat-row"><span>æ€»è®¡</span><span class="stat-value">${fmt(total)}</span></div><div class="stat-row"><span>èŠå¤©è®°å½•</span><span class="stat-value">${fmt(sizeChat)}</span></div><div class="stat-row"><span>å­˜æ¡£</span><span class="stat-value">${fmt(sizeSaves)}</span></div><div class="stat-row"><span>ä¸–ç•Œè®¾å®š</span><span class="stat-value">${fmt(sizeContent)}</span></div><div class="stat-row"><span>è®°å¿†</span><span class="stat-value">${fmt(sizeMem)}</span></div>`;
        }
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "rpg_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(node); node.click(); node.remove();
        }
        function importData(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (confirm("ç¡®å®šå¯¼å…¥ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼")) {
                        state.settings = json.settings || state.settings;
                        state.memory = json.memory || state.memory;
                        state.content = json.content || state.content;
                        state.messages = json.messages || [];
                        state.saves = json.saves || [];
                        saveData(); alert("å¯¼å…¥æˆåŠŸï¼Œå³å°†åˆ·æ–°é¡µé¢ã€‚"); location.reload();
                    }
                } catch (err) { alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯"); }
            };
            reader.readAsText(file);
        }

        // --- Scroll Logic ---
        function handleScroll() {
            const c = document.getElementById('game-container');
            const btn = document.getElementById('scroll-btn');
            if (c.scrollHeight - c.scrollTop - c.clientHeight > 200) { btn.classList.add('visible'); } else { btn.classList.remove('visible'); }
        }
        function scrollToBottom() { document.getElementById('game-container').scrollTop = document.getElementById('game-container').scrollHeight; }

        // --- Selection Logic ---
        function toggleSelectionMode() {
            state.ui.selectionMode = !state.ui.selectionMode;
            state.ui.selectedIndices.clear();
            const bar = document.getElementById('selection-bar');
            const inp = document.getElementById('main-input-area');
            const btn = document.getElementById('select-mode-btn');
            if(state.ui.selectionMode) {
                bar.classList.add('active'); inp.style.transform = "translateY(100%)"; btn.style.color = "var(--accent)";
            } else {
                bar.classList.remove('active'); inp.style.transform = "translateY(0)"; btn.style.color = "white";
            }
            reRenderChat(); updateToolbarButtons();
        }
        function handleMessageClick(index) {
            if(!state.ui.selectionMode) return;
            if(state.ui.selectedIndices.has(index)) state.ui.selectedIndices.delete(index);
            else state.ui.selectedIndices.add(index);
            reRenderChat(); updateToolbarButtons();
        }
        function updateToolbarButtons() {
            const count = state.ui.selectedIndices.size;
            document.getElementById('tool-edit').disabled = (count !== 1);
            document.getElementById('tool-regen').disabled = (count !== 1);
            document.getElementById('tool-delete').disabled = (count === 0);
        }

        // --- Modal Hooks ---
        function openScenarioModal() { document.getElementById('scenario-input').value = state.settings.authorNote; document.getElementById('modal-scenario').classList.add('active'); toggleSidebar(); }
        function closeScenarioModal() { document.getElementById('modal-scenario').classList.remove('active'); }
        function saveScenario() { state.settings.authorNote = document.getElementById('scenario-input').value; saveData(); closeScenarioModal(); }

        // --- Save/Load Split ---
        function createSave() { const name = prompt("å­˜æ¡£åç§°:", `å­˜æ¡£ ${state.saves.length+1}`); if(!name) return; const s = JSON.parse(JSON.stringify(state)); delete s.saves; state.saves.push({ id: Date.now(), name: name, date: new Date().toLocaleString(), data: s }); saveData(); renderSaveList(); }
        function renderSaveList() { const c = document.getElementById('save-list-container'); c.innerHTML = ''; state.saves.forEach(s => { c.innerHTML += `<div class="list-item"><div class="list-info" onclick="overwriteSave(${s.id})"><div class="list-title">${s.name}</div><div class="list-desc">${s.date} (ç‚¹å‡»è¦†ç›–)</div></div><div class="delete-btn" onclick="deleteSave(${s.id}, 'save')">âŒ</div></div>`; }); }
        function overwriteSave(id) { if(!confirm("è¦†ç›–æ­¤å­˜æ¡£ï¼Ÿ")) return; const idx = state.saves.findIndex(s => s.id === id); if(idx !== -1) { const snap = JSON.parse(JSON.stringify(state)); delete snap.saves; state.saves[idx].date = new Date().toLocaleString(); state.saves[idx].data = snap; saveData(); renderSaveList(); } }
        function renderLoadList() { const c = document.getElementById('load-list-container'); c.innerHTML = ''; state.saves.forEach(s => { c.innerHTML += `<div class="list-item"><div class="list-info" onclick="loadSave(${s.id})"><div class="list-title">${s.name}</div><div class="list-desc">${s.date} (ç‚¹å‡»è¯»å–)</div></div><div class="delete-btn" onclick="deleteSave(${s.id}, 'load')">âŒ</div></div>`; }); }
        function loadSave(id) { if(!confirm("è¯»å–å°†ä¸¢å¤±æœªä¿å­˜è¿›åº¦ï¼Ÿ")) return; const save = state.saves.find(s => s.id === id); if(save) { const bak = state.saves; state.settings = save.data.settings; state.memory = save.data.memory; state.content = save.data.content; state.messages = save.data.messages; state.saves = bak; saveData(); location.reload(); } }
        function deleteSave(id, type) { if(!confirm("åˆ é™¤å­˜æ¡£ï¼Ÿ")) return; state.saves = state.saves.filter(s => s.id !== id); saveData(); if(type==='save') renderSaveList(); else renderLoadList(); }
        
        const originalOpenPage = openPage; 
        openPage = function(id) { 
            if(id==='page-save') renderSaveList(); 
            if(id==='page-load') renderLoadList(); 
            if(id==='page-backup') renderStorageStats();
            originalOpenPage(id); 
        }

        // --- Core: Send & Stream ---
        async function handleSend(manual=null) {
            const inp = document.getElementById('user-input'); const txt = manual || inp.value.trim();
            if(!txt) return; if(!manual) inp.value = ''; if(!state.settings.apiKey) return alert("Missing API Key");
            appendMessage('user', txt);
            
            const aiDiv = document.createElement('div'); aiDiv.className = 'message msg-ai typing-cursor';
            document.getElementById('game-container').appendChild(aiDiv);
            scrollToBottom(); 
            
            state.memory.turnCount++;
            if(state.settings.enableAutoMem && state.memory.turnCount % state.memory.interval === 0) triggerSummary(true);
            saveData();

            try { await streamLLM(txt, aiDiv); } catch(e) { aiDiv.innerHTML += `\n[Error: ${e.message}]`; } 
            finally {
                aiDiv.classList.remove('typing-cursor');
                const raw = aiDiv.innerText;
                aiDiv.innerHTML = formatMessageHTML(raw);
                state.messages.push({role:'assistant', content:raw});
                saveData(); reRenderChat();
            }
        }

        async function streamLLM(userInput, targetDiv) {
            const c = state.content;
            const wb = c.worldbooks.find(x => x.active);
            const persona = c.personas.find(x => x.active);
            const styles = c.styles.filter(x => x.active); 
            const breaks = c.breaks.filter(x => x.active); 
            const map = c.maps.find(x => x.active);
            const statbar = c.statusbars.find(x => x.active);
            const sumP = c.summary_prompts.find(x => x.active);
            const chars = c.characters.filter(x => x.active);
            const items = c.inventory.filter(x => x.active);

            let sys = "";
            if(wb) sys += `[World]\n${wb.content}\n\n`; else sys += "You are an RPG GM.\n";
            if(map) sys += `[Loc: ${map.name}]\n${map.content}\n\n`;
            if(chars.length) sys += `[NPCs]\n` + chars.map(x=>`- ${x.name}: ${x.bio} (Opinion:${x.opinion})`).join('\n') + "\n\n";
            if(items.length) sys += `[Inventory]\n` + items.map(x=>`- ${x.name}: ${x.desc}`).join('\n') + "\n\n";
            if(persona) sys += `[User Persona]\nName: ${persona.name}\n${persona.content}\n\n`;
            if(state.memory.current) sys += `[Memory]\n${state.memory.current}\n\n`;
            
            // --- NEW STATUS BAR LOGIC ---
            if(state.settings.enableStatus && statbar) {
                sys += `[STATUS BAR]\nStart with:\n${statbar.content}\n[INSTRUCTION]: ${statbar.instruction || "Update numbers inside [ ]. No new rows."}\n`;
            }

            if(state.settings.enableSummary && sumP) sys += `[SUMMARY]\nOutput summary before choices:\n###Summary###\n(Based on: ${sumP.content})\n###EndSummary###\n`;
            
            // --- NEW DIFF LOGIC ---
            if(state.settings.enableDiffs) {
                const styleInstruction = state.settings.diffStyle ? `Rule: ${state.settings.diffStyle}` : "Append '> Stat +Val' if changed.";
                sys += `[DIFFS]\n${styleInstruction}\n`;
            }

            // --- CHOICE LOGIC FIX ---
            if(state.settings.enableChoices) sys += `\nEnd with 4 numbered choices wrapped in <c> tags. Example: <c>1. Go North</c>\n`;
            
            if(styles.length) sys += `[Style]\n${styles.map(s=>s.content).join('\n')}\n`;
            if(breaks.length) sys += `[Override]\n${breaks.map(b=>b.content).join('\n')}\n`;
            if(state.settings.authorNote) sys += `\n[SCENARIO NOTE]\n${state.settings.authorNote}\n`;

            const msgs = [{role:"system", content: sys}, ...state.messages.slice(-state.memory.limit)];

            const response = await fetch(`${state.settings.apiUrl}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${state.settings.apiKey}` },
                body: JSON.stringify({
                    model: state.settings.model, messages: msgs, temperature: parseFloat(state.settings.temperature), stream: true
                })
            });

            if(!response.ok) throw new Error("API Error");
            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let buffer = "";
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                buffer += chunk;
                const lines = buffer.split("\n");
                buffer = lines.pop();
                for (const line of lines) {
                    if (line.trim() === "data: [DONE]") return;
                    if (line.startsWith("data: ")) {
                        try {
                            const txt = JSON.parse(line.substring(6)).choices[0]?.delta?.content || "";
                            if (txt) {
                                targetDiv.innerText += txt;
                                if (document.getElementById('game-container').scrollHeight - document.getElementById('game-container').scrollTop - document.getElementById('game-container').clientHeight < 100) {
                                    scrollToBottom();
                                }
                            }
                        } catch (e) {}
                    }
                }
            }
        }

        function formatMessageHTML(raw) {
            let html = raw;
            // 1. Summary
            html = html.replace(/###Summary###([\s\S]*?)###EndSummary###/gi, (match, content) => `<details><summary>æ‘˜è¦</summary><div class="summary-content">${content.trim()}</div></details>`);
            
            // 2. Custom Choices (Tag-based to avoid conflict)
            // AI is instructed to output <c>1. Option</c>. Regex to turn this into button.
            html = html.replace(/<c>(.*?)<\/c>/g, `<span class="choice-btn" data-text="\\$1">\\$1</span>`);
            
            // 3. Fallback for old choices (Legacy Regex, but made specific to lines starting with numbers)
            // We use standard markdown lists for standard lists. We assume choices are wrapped now.
            // If user turns off wrapper, we might get standard markdown.
            
            // 4. Markdown Parse
            html = marked.parse(html);

            // 5. Diffs (Post-process Markdown output)
            // Look for > ... +1 ... inside content. Markdown turns > into blockquote.
            // Note: If AI follows custom diff instruction, it might not use ">". 
            // We'll support the standard `> Stat +1` format visualization just in case.
            html = html.replace(/(^|>)\s*>\s*(.*?)([+-]\d+)(.*?)($|<)/g, (match, prefix, label, num, suffix, end) => {
                const isPos = num.startsWith('+'); return `${prefix}<span class="${isPos?'diff-pos':'diff-neg'}">> ${label}${num}${suffix}</span>${end}`;
            });

            return html;
        }

        function appendMessage(role, text) {
            state.messages.push({role, content:text});
            reRenderChat();
        }

        function reRenderChat() {
            const container = document.getElementById('game-container');
            container.innerHTML = '';
            
            const total = state.messages.length;
            const visibleCount = state.ui.visibleMsgCount || 40;
            
            if (total > visibleCount) {
                const loadBtnContainer = document.createElement('div');
                loadBtnContainer.className = 'load-more-container';
                loadBtnContainer.innerHTML = `<button class="load-more-btn">â¬†ï¸ æŸ¥çœ‹æ›´æ—©çš„ 40 æ¡æ¶ˆæ¯</button>`;
                loadBtnContainer.onclick = () => {
                    const oldScrollH = container.scrollHeight;
                    state.ui.visibleMsgCount += 40;
                    reRenderChat();
                    const newScrollH = container.scrollHeight;
                    container.scrollTop = newScrollH - oldScrollH;
                };
                container.appendChild(loadBtnContainer);
            }

            const messagesToShow = state.messages.slice(-visibleCount);
            const startIndex = Math.max(0, total - visibleCount);

            messagesToShow.forEach((m, i) => {
                const actualIndex = startIndex + i;
                const d = document.createElement('div');
                const isSelected = state.ui.selectedIndices.has(actualIndex);
                d.className = `message ${m.role==='user'?'msg-user':'msg-ai'} ${isSelected ? 'selected' : ''}`;
                
                if (m.role === 'user') {
                    d.innerHTML = '> ' + m.content;
                } else {
                    d.innerHTML = formatMessageHTML(m.content);
                    // Add listeners to .choice-btn (New Class)
                    d.querySelectorAll('.choice-btn').forEach(btn => {
                        btn.onclick = (e) => { 
                            if (!state.ui.selectionMode) { e.stopPropagation(); handleSend(btn.getAttribute('data-text')); }
                        };
                    });
                }
                d.onclick = (e) => handleMessageClick(actualIndex);
                container.appendChild(d);
            });
            
            if(visibleCount === 40 && total > 0 && container.scrollTop === 0) container.scrollTop = container.scrollHeight;
        }

        // --- Helpers ---
        function toggleDiffConfig() {
            const on = document.getElementById('feature-diffs').checked;
            document.getElementById('diff-config-area').style.display = on ? 'block' : 'none';
        }
        function saveFeatureSettings() { 
            state.settings.enableChoices = document.getElementById('feature-choices').checked; 
            state.settings.enableStatus = document.getElementById('feature-statusbar').checked; 
            state.settings.enableDiffs = document.getElementById('feature-diffs').checked; 
            state.settings.diffStyle = document.getElementById('diff-style-input').value; // Save Diff Style
            state.settings.enableSummary = document.getElementById('feature-summary').checked; 
            saveData(); alert("Saved"); closePage('page-features'); 
        }

        // Standard boilerplates below (Delete, Edit, Regen, API, Memory, etc.)
        function actionDelete() { if(!confirm("åˆ é™¤é€‰ä¸­æ¶ˆæ¯ï¼Ÿ")) return; const indices = Array.from(state.ui.selectedIndices).sort((a,b)=>b-a); indices.forEach(i => state.messages.splice(i, 1)); toggleSelectionMode(); saveData(); }
        function actionEdit() { const idx = state.ui.selectedIndices.values().next().value; document.getElementById('edit-msg-textarea').value = state.messages[idx].content; state.ui.editingId = idx; document.getElementById('edit-modal').classList.add('active'); }
        function closeEditModal() { document.getElementById('edit-modal').classList.remove('active'); }
        function confirmMsgEdit() { state.messages[state.ui.editingId].content = document.getElementById('edit-msg-textarea').value; toggleSelectionMode(); saveData(); closeEditModal(); }
        async function actionRegenerate() {
            const idx = state.ui.selectedIndices.values().next().value; const msg = state.messages[idx];
            if(msg.role === 'assistant') { state.messages.splice(idx); saveData(); reRenderChat(); const aiDiv = document.createElement('div'); aiDiv.className = 'message msg-ai typing-cursor'; document.getElementById('game-container').appendChild(aiDiv); try { await streamLLM("", aiDiv); } finally { aiDiv.classList.remove('typing-cursor'); const raw = aiDiv.innerText; aiDiv.innerHTML = formatMessageHTML(raw); state.messages.push({role:'assistant', content:raw}); saveData(); toggleSelectionMode(); } } 
            else { state.messages.splice(idx + 1); saveData(); reRenderChat(); const aiDiv = document.createElement('div'); aiDiv.className = 'message msg-ai typing-cursor'; document.getElementById('game-container').appendChild(aiDiv); try { await streamLLM("", aiDiv); } finally { aiDiv.classList.remove('typing-cursor'); const raw = aiDiv.innerText; aiDiv.innerHTML = formatMessageHTML(raw); state.messages.push({role:'assistant', content:raw}); saveData(); toggleSelectionMode(); } }
        }
        function saveMemorySettings() { state.memory.limit = parseInt(document.getElementById('mem-limit').value); state.settings.enableAutoMem = document.getElementById('feature-auto-mem').checked; state.memory.interval = parseInt(document.getElementById('mem-interval').value); state.memory.current = document.getElementById('mem-current').value; saveData(); alert("Saved"); }
        function saveApiSettings() { state.settings.apiUrl = document.getElementById('api-url').value.replace(/\/$/, ""); state.settings.apiKey = document.getElementById('api-key').value; state.settings.temperature = document.getElementById('api-temp').value; const m = document.getElementById('api-model').value; if(m) state.settings.model=m; saveData(); alert("Saved"); closePage('page-api'); }
        async function fetchModels() { try { const r = await fetch(`${document.getElementById('api-url').value.replace(/\/$/,"")}/models`, {headers:{'Authorization':`Bearer ${document.getElementById('api-key').value}`}}); const d = await r.json(); const s = document.getElementById('api-model'); s.innerHTML=''; d.data.forEach(m=>{const o=document.createElement('option'); o.value=m.id; o.innerText=m.id; s.appendChild(o)}); alert("OK"); } catch(e){alert(e.message);} }
        function resetStory() { if(!confirm("Reset?")) return; state.messages = []; state.memory.current = ""; saveData(); reRenderChat(); toggleSidebar(); appendMessage('assistant', 'Reset done.'); }
        function toggleSidebar() { document.querySelector('.sidebar').classList.toggle('open'); document.querySelector('.sidebar-overlay').classList.toggle('open'); }
        function openPage(id) { document.getElementById(id).classList.add('active'); if(document.querySelector('.sidebar').classList.contains('open')) toggleSidebar(); }
        function closePage(id) { document.getElementById(id).classList.remove('active'); }
        function openActionSheet(i) { state.ui.selectedMsgIndex = i; document.getElementById('action-sheet').classList.add('open'); if(navigator.vibrate)navigator.vibrate(50); }
        function closeActionSheet() { document.getElementById('action-sheet').classList.remove('open'); }
        async function generateAIContent() {
            if(!state.settings.apiKey) return alert("API Key Missing");
            const cat = state.ui.currentCategory; const promptType = CAT_CONFIG[cat].prompt; if(!promptType) return;
            const btn = document.getElementById('btn-ai-gen'); btn.innerText = "Working..."; btn.disabled = true;
            try {
                const res = await fetch(`${state.settings.apiUrl}/chat/completions`, {method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${state.settings.apiKey}`},body:JSON.stringify({model:state.settings.model, messages:[{role:"system",content:"Return JSON."},{role:"user",content:`Create a ${promptType}. JSON Only.`}]})});
                const d = await res.json(); const json = JSON.parse(d.choices[0].message.content.match(/\{[\s\S]*\}/)[0]);
                if(cat==='characters') { document.getElementById('field-name').value=json.name; document.getElementById('field-bio').value=json.bio; document.getElementById('field-personality').value=json.personality; }
                else if(cat==='inventory') { document.getElementById('field-name').value=json.name; document.getElementById('field-desc').value=json.desc; }
                else if(cat==='maps') { document.getElementById('field-content').value=json.content||d.choices[0].message.content; }
            } catch(e){alert("Error");} finally { btn.innerText="âœ¨ AI è‡ªåŠ¨ç”Ÿæˆ"; btn.disabled=false; }
        }
        async function triggerSummary(silent=false) {
            if(!state.settings.apiKey) return; if(!silent) document.querySelector('button[onclick="triggerSummary()"]').innerText="Working...";
            const strat = state.content.mem_prompts.find(x=>x.active) || {content:"Summarize."};
            try { const r = await fetch(`${state.settings.apiUrl}/chat/completions`, {method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${state.settings.apiKey}`},body:JSON.stringify({model:state.settings.model, messages:[{role:'user',content:`Old Memory:\n${state.memory.current}\n\nNew Events:\n${state.messages.slice(-20).map(m=>m.content).join('\n')}\n\nTask: ${strat.content} Append to old memory.`}]})}); const d = await r.json(); state.memory.current = (state.memory.current + "\n\n" + d.choices[0].message.content).trim(); document.getElementById('mem-current').value = state.memory.current; saveData(); if(!silent) { alert("Done"); document.querySelector('button[onclick="triggerSummary()"]').innerText="âš¡ ç«‹å³è¿›è¡Œè®°å¿†æ€»ç»“ (è¿½åŠ )"; } } catch(e){}
        }
        function openList(category) { state.ui.currentCategory = category; document.getElementById('list-title').innerText = CAT_CONFIG[category].title; renderList(); openPage('page-list'); }
        function renderList() { const list = document.getElementById('list-container'); const cat = state.ui.currentCategory; const data = state.content[cat]; list.innerHTML = ''; data.forEach((item, index) => { const div = document.createElement('div'); div.className = `list-item ${item.active ? 'active-item' : ''}`; div.innerHTML = `<div class="select-indicator" onclick="event.stopPropagation(); toggleActive('${cat}', ${index})"></div><div class="list-info" onclick="event.stopPropagation(); toggleActive('${cat}', ${index})"><div class="list-title">${item.name||'æœªå‘½å'}</div><div class="list-desc">${item.content||item.desc||item.bio||''}</div></div><div class="edit-btn" onclick="event.stopPropagation(); openEditor(${index})">âœ</div>`; list.appendChild(div); }); }
        function toggleActive(category, index) { const type = CAT_CONFIG[category].type; const data = state.content[category]; if (type === 'single') { if(data[index].active) data[index].active = false; else { data.forEach(i => i.active = false); data[index].active = true; } } else data[index].active = !data[index].active; saveData(); renderList(); }
        function openEditor(index) { state.ui.editingId = index; const cat = state.ui.currentCategory; const fields = CAT_CONFIG[cat].fields; const c = document.getElementById('editor-fields'); c.innerHTML = ''; document.getElementById('editor-title').innerText = (index===-1?'æ–°å»º':'ç¼–è¾‘') + CAT_CONFIG[cat].title; document.getElementById('btn-delete').style.display = index===-1 ? 'none':'block'; document.getElementById('btn-ai-gen').style.display = CAT_CONFIG[cat].prompt ? 'flex' : 'none'; const item = index !== -1 ? state.content[cat][index] : {}; fields.forEach(f => { const w = document.createElement('div'); w.className='form-group'; w.innerHTML = `<label class="form-label">${FIELD_LABELS[f]||f}</label>`; const input = (f==='name'||f==='personality'||f==='opinion') ? document.createElement('input') : document.createElement('textarea'); input.className = input.tagName==='INPUT'?'form-input':'form-textarea'; if(f==='content'||f==='instruction') input.style.height = '150px'; input.id = `field-${f}`; input.value = item[f] || ''; w.appendChild(input); c.appendChild(w); }); openPage('page-editor'); }
        function saveEntry() { const cat = state.ui.currentCategory; const entry = {}; CAT_CONFIG[cat].fields.forEach(f => entry[f] = document.getElementById(`field-${f}`).value); entry.active = state.ui.editingId !== -1 ? state.content[cat][state.ui.editingId].active : false; if(state.ui.editingId === -1) state.content[cat].push(entry); else state.content[cat][state.ui.editingId] = entry; saveData(); renderList(); closePage('page-editor'); }
        function deleteEntry() { if(!confirm("åˆ é™¤?")) return; state.content[state.ui.currentCategory].splice(state.ui.editingId, 1); saveData(); renderList(); closePage('page-editor'); }
    </script>
</body>
</html>